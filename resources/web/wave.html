<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="qrc:/resources/web/echarts.min.js"></script>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: transparent !important;
        }
        #chart {
            width: 100%;
            height: 100%;
            min-width: 100px;
            min-height: 100px;
            background-color: #FFFFFF;
        }
    </style>
</head>
<body>
<div id="chart"></div>
<script>
    var myChart = echarts.init(document.getElementById('chart'));
    var chartData = {};

    // 添加尺寸监控变量
    let lastWidth = 0;
    let lastHeight = 0;
    let resizeScheduled = false;

    // 默认配置
    var option = {
        animation: false, // 禁用动画以提高重绘性能
        title: {
            text: 'IKUN示波器',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            formatter: function(params) {
                var result = '时间: ' + params[0].data[0] + 'ms<br/>';
                params.forEach(function(item) {
                    result += item.seriesName + ': ' + item.data[1].toFixed(2) + '<br/>';
                });
                return result;
            }
        },
        legend: {
            data: [],
            top: 30
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '10%',
            top: '15%',
            containLabel: true
        },
        toolbox: {
            feature: {
                dataZoom: { yAxisIndex: 'none' },
                magicType: { type: ['line', 'bar'] }
            }
        },
        xAxis: {
            type: 'value',
            name: '时间(ms)',
            nameLocation: 'middle',
            nameGap: 30
        },
        yAxis: {
            type: 'value',
            name: '',
            nameLocation: 'middle',
            nameGap: 50
        },
        dataZoom: [
            {
                type: 'inside',
                xAxisIndex: [0],
                start: 0,
                end: 100,
                zoomOnMouseWheel: true,
                moveOnMouseMove: true
            },
            {
                show: true,
                xAxisIndex: [0],
                type: 'slider',
                top: '90%',
                start: 0,
                end: 100
            }
        ],
        series: []
    };

    myChart.setOption(option);

    // 添加示例数据标志
    var hasRealData = false;
    
    // 显示示例坐标轴数据
    function showExampleData() {
        if (hasRealData) return;
        
        var exampleOption = {
            xAxis: {
                type: 'value',
                name: '时间(ms)',
                nameLocation: 'middle',
                nameGap: 30,
                min: 0,
                max: 1000,
                interval: 200
            },
            yAxis: {
                type: 'value',
                name: '',
                nameLocation: 'middle',
                nameGap: 50,
                min: -100,
                max: 100,
                interval: 50
            }
        };
        myChart.setOption(exampleOption);
    }

    // 初始显示示例
    setTimeout(showExampleData, 100);

    // 增强的尺寸监控逻辑
    function checkSizeChange() {
        const chartDiv = document.getElementById('chart');
        if (!chartDiv) return;

        const currentWidth = chartDiv.clientWidth;
        const currentHeight = chartDiv.clientHeight;

        // 尺寸未变化或变化过小则忽略
        if (Math.abs(currentWidth - lastWidth) < 2 &&
            Math.abs(currentHeight - lastHeight) < 2) {
            return;
        }

        lastWidth = currentWidth;
        lastHeight = currentHeight;

        if (myChart && !myChart.isDisposed()) {
            try {
                myChart.resize();
                console.log(`图表重绘完成 (${currentWidth}x${currentHeight})`);
            } catch (e) {
                console.error('重绘失败:', e);
            }
        }
    }

    // 使用requestAnimationFrame进行高效监控
    function monitorSizeChanges() {
        if (!document.hidden) {
            checkSizeChange();
        }
        requestAnimationFrame(monitorSizeChanges);
    }

    // 启动尺寸监控
    requestAnimationFrame(monitorSizeChanges);

    // 保留窗口resize监听作为备用
    window.addEventListener('resize', function() {
        if (!resizeScheduled) {
            resizeScheduled = true;
            requestAnimationFrame(function() {
                checkSizeChange();
                resizeScheduled = false;
            });
        }
    });

    // 初始尺寸记录
    setTimeout(() => {
        const chartDiv = document.getElementById('chart');
        if (chartDiv) {
            lastWidth = chartDiv.clientWidth;
            lastHeight = chartDiv.clientHeight;
        }
    }, 500);

    // Qt调用的接口 - 添加新的数据系列
    function addSeries(name, color) {
        // 标记有真实数据，清除示例
        if (!hasRealData) {
            hasRealData = true;
            // 重置坐标轴为自动模式
            var resetOption = {
                xAxis: { min: null, max: null, interval: null },
                yAxis: { min: null, max: null, interval: null }
            };
            myChart.setOption(resetOption);
        }

        if (!chartData[name]) {
            chartData[name] = [];
            
            // 生成示例数据
            for (let i = 0; i < 50; i++) {
                let time = i * 20;
                chartData[name].push([time, 0]);
            }
        }

        var currentOption = myChart.getOption();
        var seriesExists = currentOption.series.some(function (series) {
            return series.name === name;
        });

        if (!seriesExists) {
            currentOption.legend[0].data.push(name);
            currentOption.series.push({
                name: name,
                type: 'line',
                data: chartData[name], // 使用生成的示例数据
                lineStyle: {color: color, width: 2},
                symbol: 'circle',
                symbolSize: 4,
                smooth: true,
                animation: false
            });
            myChart.setOption(currentOption);
        }
    }

    // 设置指定系列的完整数据
    function setSeriesData(seriesName, data) {
        chartData[seriesName] = data;

        var currentOption = myChart.getOption();

        // 更新指定系列的数据
        var updated = false;
        currentOption.series.forEach(function (series) {
            if (series.name === seriesName) {
                series.data = data;
                updated = true;
            }
        });

        if (!updated) {
            console.error('未找到系列:', seriesName);
            console.log('当前系列列表:', currentOption.series.map(s => s.name));
        }

        // 强制刷新图表
        myChart.setOption(currentOption, true);
    }

    // 添加数据点到指定系列
    function addDataPoint(seriesName, timestamp, value) {
        if (!chartData[seriesName]) {
            chartData[seriesName] = [];
        }
        chartData[seriesName].push([timestamp, value]);
        updateChart();
    }

    // 批量添加多个数据点
    function addDataPoints(seriesName, points) {
        if (!chartData[seriesName]) {
            chartData[seriesName] = [];
        }
        chartData[seriesName] = chartData[seriesName].concat(points);
        updateChart();
    }

    // 更新图表显示
    function updateChart() {
        var currentOption = myChart.getOption();

        // 更新每个系列的数据
        currentOption.series.forEach(function (series) {
            if (chartData[series.name]) {
                series.data = chartData[series.name];
            }
        });

        myChart.setOption(currentOption, false, false);
    }

    // 清除所有数据
    function clearAllData() {
        chartData = {};
        hasRealData = false;
        var currentOption = myChart.getOption();
        currentOption.series.forEach(function (series) {
            series.data = [];
        });
        currentOption.series = [];
        currentOption.legend[0].data = [];
        myChart.setOption(currentOption, false, false);
        
        // 重新显示示例
        setTimeout(showExampleData, 100);
    }

    // 清除指定系列数据
    function clearSeriesData(seriesName) {
        if (chartData[seriesName]) {
            chartData[seriesName] = [];
        }
        updateChart();
    }

    // 移除系列
    function removeSeries(seriesName) {
        delete chartData[seriesName];

        var currentOption = myChart.getOption();

        // 从图例中移除
        var legendIndex = currentOption.legend[0].data.indexOf(seriesName);
        if (legendIndex > -1) {
            currentOption.legend[0].data.splice(legendIndex, 1);
        }

        // 从系列中移除
        currentOption.series = currentOption.series.filter(function (series) {
            return series.name !== seriesName;
        });

        myChart.setOption(currentOption);
    }

    // 获取数据统计信息
    function getDataStats() {
        var stats = {};
        for (var seriesName in chartData) {
            var data = chartData[seriesName];
            if (data.length > 0) {
                var values = data.map(function (point) {
                    return point[1];
                });
                stats[seriesName] = {
                    count: data.length,
                    min: Math.min.apply(Math, values),
                    max: Math.max.apply(Math, values),
                    avg: values.reduce(function (a, b) {
                        return a + b;
                    }, 0) / values.length
                };
            }
        }
        return stats;
    }

    // 设置图表标题
    function setChartTitle(title) {
        var currentOption = myChart.getOption();
        currentOption.title[0].text = title;
        myChart.setOption(currentOption);
    }

    // 导出数据为JSON
    function exportData() {
        return JSON.stringify(chartData);
    }

    // 从JSON导入数据
    function importData(jsonData) {
        try {
            chartData = JSON.parse(jsonData);
            updateChart();
            return true;
        } catch (error) {
            console.error('导入数据失败:', error);
            return false;
        }
    }

    console.log('波形图表初始化完成');
</script>
</body>
</html>